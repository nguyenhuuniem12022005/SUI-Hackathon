import axios from "axios";

const API_URL = process.env.NEXT_PUBLIC_API_BASE_URL || "http://localhost:3001";

export const buildAvatarUrl = (src) => {
  if (!src || typeof src !== "string") return "/avatar.png";
  const trimmed = src.trim();
  if (/^(https?:|data:)/i.test(trimmed) || trimmed.startsWith("//")) return trimmed;

  const cleaned = trimmed.replace(/^public\//i, "").replace(/^\/+/, "");
  const base = API_URL.replace(/\/$/, "");
  return `${base}/${cleaned}`;
};

// ===================== TOKEN QU·∫¢N L√ù =====================
/**
 * L∆∞u token v√†o localStorage.
 */
export const setAuthToken = (token) => {
  if (typeof window !== "undefined") {
    localStorage.setItem("pmarket_token", token);
  }
};

/**
 * L·∫•y token t·ª´ localStorage.
 */
export const getAuthToken = () => {
  if (typeof window !== "undefined") {
    return localStorage.getItem("pmarket_token");
  }
  return null;
};

/**
 * X√≥a token v√† user data kh·ªèi localStorage (khi ƒëƒÉng xu·∫•t).
 */
export const removeAuthToken = () => {
  if (typeof window !== "undefined") {
    localStorage.removeItem("pmarket_token");
    localStorage.removeItem("pmarket_user");
  }
};

// === HEADER T·ª∞ ƒê·ªòNG TH√äM TOKEN ===
/**
 * T·ª± ƒë·ªông t·∫°o header Authorization n·∫øu c√≥ token.
 */
function authHeader() {
  const token = getAuthToken();
  return token ? { Authorization: `Bearer ${token}` } : {};
}

// ===================== X·ª¨ L√ù L·ªñI AXIOS CHUNG =====================
/**
 * X·ª≠ l√Ω l·ªói t·∫≠p trung cho c√°c request axios.
 */
function handleAxiosError(error) {
  if (error.response) {
    const message =
      error.response.data.message || `L·ªói API (${error.response.status})`;
    throw new Error(message);
  }
  throw new Error("Y√™u c·∫ßu m·∫°ng th·∫•t b·∫°i ho·∫∑c l·ªói kh√¥ng x√°c ƒë·ªãnh.");
}

// ===================== AUTH API =====================

/**
 * ‚úÖ ƒêƒÉng k√Ω
 */
export async function registerUser(formData) {
  try {
    const res = await axios.post(`${API_URL}/auth/register`, formData);
    return res.data;
  } catch (error) {
    handleAxiosError(error);
  }
}

/**
 * ‚úÖ ƒêƒÉng nh·∫≠p
 * [ƒê√É S·ª¨A] T·ª± ƒë·ªông l∆∞u token v√† user info v√†o localStorage.
 */
export async function loginUser(email, password) {
  try {
    const res = await axios.post(`${API_URL}/auth/login`, { email, password });
    const data = res.data;

    if (data.success && data.token) {
      const tokenString = data.token.access_token;
      const userInfo = data.user;
      setAuthToken(tokenString);
      if (typeof window !== "undefined") {
        localStorage.setItem("pmarket_user", JSON.stringify(userInfo));
      }
    }
    return data;
  } catch (error) {
    handleAxiosError(error);
  }
}

/**
 * ‚úÖ ƒêƒÉng xu·∫•t
 * [ƒê√É S·ª¨A] T·ª± ƒë·ªông x√≥a token v√† user info kh·ªèi localStorage.
 */
export async function logoutUser() {
  try {
    const res = await axios.post(
      `${API_URL}/auth/logout`,
      {},
      { headers: authHeader() }
    );
    removeAuthToken();
    return res.data;
  } catch (error) {
    removeAuthToken();
    handleAxiosError(error);
  }
}

// ===================== USER API =====================

/**
 * ‚úÖ Upload avatar
 */
export async function uploadUserAvatar(file) {
  try {
    const formData = new FormData();
    formData.append("avatar", file);

    const res = await axios.patch(
      `${API_URL}/users/me/upload-avatar`,
      formData,
      {
        headers: {
          ...authHeader(),
          "Content-Type": "multipart/form-data",
        },
      }
    );

    return res.data;
  } catch (error) {
    handleAxiosError(error);
  }
}

/**
 * ‚úÖ C·∫≠p nh·∫≠t th√¥ng tin ng∆∞·ªùi d√πng (userName, phone, address)
 */
export async function updateUserProfile(profileData = {}) {
  try {
    const userName = profileData.userName || "";
    const phone = profileData.phone || "";
    const address = profileData.address || "";

    const headers = {
      ...authHeader(),
      "Content-Type": "application/json",
    };

    const results = [];

    if (userName.trim() !== "") {
      const res = await axios.patch(
        `${API_URL}/users/me/update-userName`,
        { userName },
        { headers }
      );
      results.push(res.data);
    }

    if (phone.trim() !== "") {
      const res = await axios.patch(
        `${API_URL}/users/me/update-phone`,
        { phone },
        { headers }
      );
      results.push(res.data);
    }

    if (address.trim() !== "") {
      const res = await axios.patch(
        `${API_URL}/users/me/update-address`,
        { address },
        { headers }
      );
      results.push(res.data);
    }

    if (results.length === 0) {
      return { success: false, message: "Kh√¥ng c√≥ d·ªØ li·ªáu n√†o ƒë·ªÉ c·∫≠p nh·∫≠t." };
    }

    return {
      success: true,
      message: "C·∫≠p nh·∫≠t th√¥ng tin c√° nh√¢n th√†nh c√¥ng!",
      results,
    };
  } catch (error) {
    handleAxiosError(error);
  }
}

/**
 * ‚úÖ ƒê·ªïi m·∫≠t kh·∫©u
 */
export async function resetPasswordAPI(newPassword) {
  try {
    const res = await axios.patch(
      `${API_URL}/users/me/update-password`,
      { password: newPassword },
      { headers: authHeader() }
    );
    return res.data;
  } catch (error) {
    handleAxiosError(error);
  }
}

/**
 * L?y t?t c? s?n ph?m (g?n ‚y nh?t)
 */

/**
 * L?y chi ti?t s?n ph?m theo ID
 */
export async function getProductById(productId) {
  try {
    const res = await axios.get(
      `${API_URL}/products/${productId}`,
      { headers: authHeader() }
    );
    return res.data.product || null;
  } catch (error) {
    console.error('Error fetching product details:', error);
    return null;
  }
}

/**
 * L?y danh s·ch ·nh gi· c?a s?n ph?m (mock data - s? tÌch h?p API th?c sau)
 */
export async function getReviewsByProductId(productId) {
  // TODO: TÌch h?p API th?c khi backend cÛ endpoint reviews
  return [
    {
      id: 1,
      userName: 'Nguy?n V„n A',
      rating: 5,
      comment: 'S?n ph?m r?t t?t, ˙ng nh˝ mÙ t?!',
      createdAt: '2024-01-15',
      avatar: '/avatar.png'
    },
    {
      id: 2,
      userName: 'Tr?n Th? B',
      rating: 4,
      comment: 'Ch?t l˝?ng ?n, giao h‡ng nhanh.',
      createdAt: '2024-01-10',
      avatar: '/avatar.png'
    }
  ];
}
export async function getAllProducts(limit = 50) {
  try {
    // API cÙng khai - khÙng c?n token
    const res = await axios.get(`${API_URL}/products`);
    
    const products = res.data.products || [];
    // Gi?i h?n s? l˝?ng s?n ph?m hi?n th?
    return products.slice(0, limit);
  } catch (error) {
    console.error('Error fetching products:', error);
    return [];
  }
}
export async function updateUserDateOfBirth(dateOfBirth) {
  try {
    const res = await axios.patch(
      `${API_URL}/users/me/update-date-of-birth`,
      { dateOfBirth },
      { headers: authHeader() }
    );
    return res.data;
  } catch (error) {
    handleAxiosError(error);
  }
}

export async function adjustReputationScore(amount) {
  try {
    const res = await axios.patch(
      `${API_URL}/users/me/update-reputation-score`,
      { amount },
      { headers: authHeader() }
    );
    return res.data;
  } catch (error) {
    handleAxiosError(error);
  }
}

export async function adjustGreenCredit(amount) {
  try {
    const res = await axios.patch(
      `${API_URL}/users/me/update-green-credit`,
      { amount },
      { headers: authHeader() }
    );
    return res.data;
  } catch (error) {
    handleAxiosError(error);
  }
}

// ===================== PRODUCT API =====================

/**
 * T·∫°o s·∫£n ph·∫©m m·ªõi (ƒêƒÉng b√†i)
 */
export async function createProduct(productData) {
  try {
    const res = await axios.post(
      `${API_URL}/products/new-product`,
      productData,  // FormData s? ˝?c g?i tr?c ti?p
      { 
        headers: {
          ...authHeader(),
          // KhÙng set Content-Type, ? browser t? ?ng set cho FormData
        }
      }
    );
    return res.data;
  } catch (error) {
    handleAxiosError(error);
  }
}

/**
 * T√¨m ki·∫øm s·∫£n ph·∫©m
 */
export async function searchProducts(params = {}) {
  try {
    const queryParams = new URLSearchParams();
    if (params.searchTerm) queryParams.append('searchTerm', params.searchTerm);
    if (params.q) queryParams.append('searchTerm', params.q);
    if (params.categoryId) queryParams.append('categoryId', params.categoryId);

    const res = await axios.get(
      `${API_URL}/products?${queryParams.toString()}`,
      { headers: authHeader() }
    );
    
    return {
      success: res.data.success,
      items: res.data.products || [],
      message: res.data.message
    };
  } catch (error) {
    handleAxiosError(error);
  }
}

/**
 * C·∫≠p nh·∫≠t s·∫£n ph·∫©m
 */
export async function updateProduct(productId, productData) {
  try {
    const res = await axios.put(
      `${API_URL}/products/${productId}/update-product`,
      productData,
      { headers: authHeader() }
    );
    return res.data;
  } catch (error) {
    handleAxiosError(error);
  }
}

/**
 * X√≥a s·∫£n ph·∫©m
 */
export async function deleteProduct(productId) {
  try {
    const res = await axios.delete(
      `${API_URL}/products/${productId}/delete-product`,
      { headers: authHeader() }
    );
    return res.data;
  } catch (error) {
    handleAxiosError(error);
  }
}

// ===================== CATEGORY API =====================

/**
 * L·∫•y danh s√°ch t·∫•t c·∫£ danh m·ª•c
 */
export async function fetchCategories() {
  try {
    const res = await axios.get(`${API_URL}/categories`, {
      headers: authHeader()
    });
    return res.data;
  } catch (error) {
    console.warn('fetchCategories error:', error.message);
    return {
      success: true,
      categories: [
        { categoryId: 1, categoryName: 'S√°ch & VƒÉn ph√≤ng ph·∫©m' },
        { categoryId: 2, categoryName: 'ƒê·ªì ƒëi·ªán t·ª≠' },
        { categoryId: 3, categoryName: 'Th·ªùi trang' },
        { categoryId: 4, categoryName: 'ƒê·ªì gia d·ª•ng' },
        { categoryId: 5, categoryName: 'Th·ªÉ thao & S·ª©c kh·ªèe' },
        { categoryId: 6, categoryName: 'Kh√°c' }
      ]
    };
  }
}







